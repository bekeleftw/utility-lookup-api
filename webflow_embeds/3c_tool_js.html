<script>
(function (){var API_URL='https://web-production-9acc6.up.railway.app/api/lookup';var STREAM_URL='https://web-production-9acc6.up.railway.app/api/lookup/stream';var FEEDBACK_URL='https://web-production-9acc6.up.railway.app/api/feedback';var icons={electric:'‚ö°',gas:'üî•',water:'üíß',sewer:'üöø',internet:'üåê'};var typeLabels={electric:'Electric',gas:'Natural Gas',water:'Water',sewer:'Sewer',internet:'Internet'};var modeTabs=document.querySelectorAll('.up-mode-tab');var singleForm=document.getElementById('singleForm');var multiForm=document.getElementById('multiForm');var csvForm=document.getElementById('csvForm');var utilityResults=document.getElementById('utilityResults');var multiResults=document.getElementById('multiResults');var addressInput=document.getElementById('addressInput');var searchBtn=document.getElementById('searchBtn');var multiInput=document.getElementById('multiInput');var multiSearchBtn=document.getElementById('multiSearchBtn');modeTabs.forEach(function (tab){tab.addEventListener('click',function (){modeTabs.forEach(function (t){t.classList.remove('active');});this.classList.add('active');var mode=this.dataset.mode;singleForm.classList.toggle('up-hidden',mode!=='single');multiForm.classList.toggle('up-hidden',mode!=='multi');csvForm.classList.toggle('up-hidden',mode!=='csv');utilityResults.classList.toggle('up-hidden',mode!=='single');multiResults.classList.toggle('up-hidden',mode!=='multi');});});document.querySelectorAll('#singleToggles .up-toggle') .forEach(function (toggle){toggle.addEventListener('click',function (e){e.preventDefault();var checkbox=toggle.querySelector('input');checkbox.checked=!checkbox.checked;toggle.classList.toggle('active',checkbox.checked);});});document.querySelectorAll('#multiToggles .up-toggle') .forEach(function (toggle){toggle.addEventListener('click',function (e){e.preventDefault();var checkbox=toggle.querySelector('input');checkbox.checked=!checkbox.checked;toggle.classList.toggle('active',checkbox.checked);});});function getSelectedUtilities(container){var selected=[];container.querySelectorAll('.up-toggle') .forEach(function (toggle){if(toggle.querySelector('input') .checked)selected.push(toggle.dataset.utility);});return selected;}var sourceExplanations={'state_gis':'Matched via official state GIS utility boundary data','hifld':'Matched via federal HIFLD utility service territory','municipal':'Matched to municipal/city-owned utility','county_default':'Default utility for this county','eia_861':'Matched via EIA-861 utility data','serp_verified':'Verified via web search results','tenant_verified':'Verified by tenant reports for this ZIP'};function getSourceExplanation(source){if(!source)return '';var s=source.toLowerCase();for(var key in sourceExplanations){if(s.indexOf(key)>=0)return sourceExplanations[key];}return source;}function getConfidenceBadgeWithDropdown(util,cardId){var score=util.confidence_score;var source=util._source||util.source||'';var badgeClass,badgeLabel;if(score!==undefined&&score!==null){if(score>=85){badgeClass='up-badge-verified';badgeLabel='Verified';}else if(score>=70){badgeClass='up-badge-high';badgeLabel='High Confidence';}else if(score>=50){badgeClass='up-badge-medium';badgeLabel='Medium';}else{badgeClass='up-badge-low';badgeLabel='Low Confidence';}}else{var confidence=util.confidence||'medium';var map={verified:{c:'up-badge-verified',l:'Verified'},high:{c:'up-badge-high',l:'High Confidence'},medium:{c:'up-badge-medium',l:'Medium'},low:{c:'up-badge-low',l:'Low Confidence'}};var m=map[confidence]||map.medium;badgeClass=m.c;badgeLabel=m.l;}var explanation=getSourceExplanation(source);var dropdownContent=(score!==undefined&&score!==null)?(explanation?'<span class="score">'+score+'/100</span>-'+explanation:'<span class="score">'+score+'/100</span>confidence'):(explanation||'Confidence details unavailable');return '<span class="up-badge '+badgeClass+' up-badge-confidence" data-dropdown="'+cardId+'-dropdown">'+badgeLabel+'<span class="up-badge-caret">‚ñº</span></span>'+'<div class="up-confidence-dropdown" id="'+cardId+'-dropdown">'+dropdownContent+'</div>';}function getTechType(tech){if(!tech)return{label:'Unknown',dot:''};var t=tech.toLowerCase();if(t.indexOf('fiber')>=0)return{label:'Fiber',dot:'fiber'};if(t.indexOf('cable')>=0||t.indexOf('docsis')>=0)return{label:'Cable',dot:'cable'};if(t.indexOf('dsl')>=0)return{label:'DSL',dot:'dsl'};if(t.indexOf('5g')>=0||t.indexOf('lte')>=0||t.indexOf('wireless')>=0||t.indexOf('fixed')>=0)return{label:'Wireless',dot:'wireless'};if(t.indexOf('satellite')>=0)return{label:'Satellite',dot:'satellite'};return{label:tech,dot:''};}function renderUtilityCard(util,type,address){var cardId='card-'+type+'-'+Date.now()+'-'+Math.random() .toString(36) .substr(2,5);var badges='';if(util.type&&['MUD','CDD','PUD','WCID','Metro District'].indexOf(util.type)>=0){badges+='<span class="up-badge up-badge-district">'+util.type+'</span>';}badges+=getConfidenceBadgeWithDropdown(util,cardId);var detailsLeft='';if(util.phone&&util.phone!=='NOT AVAILABLE'){detailsLeft+='<div class="up-detail"><span class="up-detail-label">Phone</span><span class="up-detail-value"><a href="https://liberty-upt.vercel.app/?address='+encodeURIComponent(address)+'&provider='+encodeURIComponent(util.name)+'&phone='+util.phone.replace(/[^0-9]/g,'')+'&type='+encodeURIComponent(type)+'" target="_blank">'+util.phone+'</a></span></div>';}if(util.website&&util.website!=='NOT AVAILABLE'){var url=util.website.indexOf('http')===0?util.website:'https://'+util.website;detailsLeft+='<div class="up-detail"><span class="up-detail-label">Website</span><span class="up-detail-value"><a href="'+url+'" target="_blank">Visit site</a></span></div>';}if(util.service_check_url){detailsLeft+='<div class="up-detail"><span class="up-detail-label">Verify</span><span class="up-detail-value"><a href="'+util.service_check_url+'" target="_blank" class="up-confirm-link">‚úì Confirm Service</a></span></div>';}var deregSection='';if(type==='electric'&&util.deregulated&&util.deregulated.has_choice){var dereg=util.deregulated;deregSection='<div class="up-dereg-banner"><div class="up-dereg-header"><span class="up-dereg-icon">üéâ</span><span class="up-dereg-title">'+(dereg.message||'Retail choice available')+'</span></div>'+(dereg.choice_website?'<a href="'+dereg.choice_website+'" target="_blank" class="up-dereg-cta"><span>üîç</span>Compare Providers</a>':'')+'</div>';}var otherSection='';if(util.other_providers&&util.other_providers.length>0){var altId=cardId+'-others';function normalizeName(name){if(!name)return '';return name.toUpperCase() .replace(/\s*-\s*\(?[A-Z]{2}\)?$/i,'') .replace(/\s*\([A-Z]{2}\)$/i,'') .replace(/\s+(INC|LLC|CORP|CO|COMPANY|CORPORATION)\.?$/i,'') .replace(/[^A-Z0-9]/g,'');}var primaryNorm=normalizeName(util.name);var seenNames={};seenNames[primaryNorm]=true;var dedupedProviders=util.other_providers.filter(function (p){var normName=normalizeName(p.name);if(seenNames[normName])return false;seenNames[normName]=true;return true;});var otherRows=dedupedProviders.map(function (p,i){var altItemId=cardId+'-alt-'+i;var pName=p.name?p.name.split(' ') .map(function (w){return w.charAt(0) .toUpperCase()+w.slice(1) .toLowerCase();}) .join(' '):'Unknown';var altDetails='';if(p.phone&&p.phone!=='NOT AVAILABLE'){altDetails+='<div class="up-detail"><span class="up-detail-label">Phone</span><span class="up-detail-value"><a href="tel:'+p.phone+'">'+p.phone+'</a></span></div>';}if(p.website&&p.website!=='NOT AVAILABLE'){var wurl=p.website.indexOf('http')===0?p.website:'https://'+p.website;altDetails+='<div class="up-detail"><span class="up-detail-label">Website</span><span class="up-detail-value"><a href="'+wurl+'" target="_blank">Visit site</a></span></div>';}var propaneNote=p.is_propane?'<span class="up-propane-note">‚ö†Ô∏è Propane/LP gas dealer(not piped natural gas)</span>':'';return '<div class="up-alt-provider" id="'+altItemId+'">'+'<div class="up-alt-name">'+pName+'</div>'+propaneNote+'<div class="up-alt-details">'+'<div class="up-alt-contact">'+altDetails+'</div>'+'<div class="up-feedback-inline">'+'<span>Correct?</span>'+'<button class="up-feedback-btn-small up-alt-btn yes" data-alt-id="'+altItemId+'" data-provider="'+(p.name||'') .replace(/"/g,'&quot;')+'" data-type="'+type+'" data-response="yes">Yes</button>'+'<button class="up-feedback-btn-small up-alt-btn no" data-alt-id="'+altItemId+'" data-provider="'+(p.name||'') .replace(/"/g,'&quot;')+'" data-type="'+type+'" data-response="no">No</button>'+'<span class="up-alt-done" id="'+altItemId+'-done">Thanks!</span>'+'</div>'+'</div>'+'</div>';}) .join('');otherSection='<div class="up-other-providers">'+'<div class="up-other-toggle" data-target="'+altId+'">Other possible providers<span class="up-other-caret">‚ñº</span></div>'+'<div class="up-other-list" id="'+altId+'">'+otherRows+'</div>'+'</div>';}return '<div class="up-card" id="'+cardId+'">'+'<div class="up-card-header">'+'<div class="up-card-type"><div class="up-icon up-icon-'+type+'">'+icons[type]+'</div><span class="up-type-label">'+typeLabels[type]+'</span></div>'+'<div class="up-header-badges">'+badges+'</div>'+'</div>'+'<div class="up-provider-name">'+(util.name||'Unknown')+'</div>'+deregSection+'<div class="up-details">'+'<div class="up-details-left">'+detailsLeft+'</div>'+'<div class="up-feedback-inline" data-card="'+cardId+'" data-type="'+type+'" data-provider="'+(util.name||'') .replace(/"/g,'&quot;')+'" data-address="'+address.replace(/"/g,'&quot;')+'">'+'<span>Correct?</span>'+'<button class="up-feedback-btn-small yes" data-response="yes">Yes</button>'+'<button class="up-feedback-btn-small no" data-response="no">No</button>'+'<span class="up-feedback-done" id="'+cardId+'-done">Thanks!</span>'+'</div>'+'</div>'+otherSection+'<div class="up-feedback-form" id="'+cardId+'-form">'+'<label>What is the correct '+typeLabels[type].toLowerCase()+' provider?</label>'+'<input type="text" placeholder="Enter correct provider name" id="'+cardId+'-correction"/>'+'<button class="up-feedback-submit" data-card="'+cardId+'" data-type="'+type+'">Submit</button>'+'</div>'+'<div class="up-url-form" id="'+cardId+'-url-form">'+'<label>Know where to check service?(optional)</label>'+'<input type="url" placeholder="https://utility.com/start-service" id="'+cardId+'-service-url"/>'+'<div class="up-url-buttons">'+'<button class="up-url-submit" data-card="'+cardId+'" data-type="'+type+'">Submit</button>'+'<button class="up-url-skip" data-card="'+cardId+'">Skip</button>'+'</div>'+'</div>'+'</div>';}function renderInternetCard(inet){var providers=inet.providers||[];if(providers.length===0)return '<div class="up-card"><div class="up-no-result">üåê No internet providers found</div></div>';var sorted=providers.slice() .sort(function (a,b){return(b.max_download_mbps||0)-(a.max_download_mbps||0);});var hasFiber=sorted.some(function (p){return(p.technology||'') .toLowerCase() .indexOf('fiber')>=0;});var hasCable=sorted.some(function (p){return(p.technology||'') .toLowerCase() .indexOf('cable')>=0;});var badge='<span class="up-badge up-badge-medium">Limited Options</span>';if(hasFiber)badge='<span class="up-badge up-badge-verified">Fiber Available</span>';else if(hasCable)badge='<span class="up-badge up-badge-high">Cable Available</span>';var rows=sorted.map(function (p){var tech=getTechType(p.technology);var down=p.max_download_mbps||'?';var up=p.max_upload_mbps||'?';return '<tr><td class="up-internet-provider-cell">'+(p.name||'Unknown')+'</td><td><span class="up-internet-type-cell"><span class="up-internet-type-dot '+tech.dot+'"></span>'+tech.label+'</span></td><td class="up-internet-speed-cell"><span class="up-internet-speed-down">'+down+'</span>/'+up+' Mbps</td></tr>';}) .join('');return '<div class="up-card">'+'<div class="up-card-header">'+'<div class="up-card-type"><div class="up-icon up-icon-internet">'+icons.internet+'</div><span class="up-type-label">Internet</span></div>'+'<div class="up-header-badges">'+badge+'</div>'+'</div>'+'<table class="up-internet-table"><thead><tr><th>Provider</th><th>Type</th><th>Speed</th></tr></thead><tbody>'+rows+'</tbody></table>'+'<div class="up-feedback-inline" data-card="internet-card" data-type="internet" data-provider="'+sorted.map(function(p){return p.name}).join(', ')+'" data-address="'+addressInput.value+'">'+'<span class="up-feedback-label">Correct?</span>'+'<button class="up-feedback-btn-small yes" data-response="yes" data-card="internet-card">Yes</button>'+'<button class="up-feedback-btn-small no" data-response="no" data-card="internet-card">No</button>'+'<span class="up-feedback-done" id="internet-card-done">Thanks!</span>'+'</div>'+'<div id="internet-card-url-form" class="up-url-form">'+'<label>Know where to check service? (optional)</label>'+'<input type="url" placeholder="https://provider.com/check-availability" id="internet-card-service-url"/>'+'<div class="up-url-buttons">'+'<button class="up-url-submit" data-card="internet-card" data-type="internet">Submit</button>'+'<button class="up-url-skip" data-card="internet-card">Skip</button>'+'</div>'+'</div>'+'<div class="up-feedback-form" id="internet-card-form">'+'<label>What are the correct internet providers?</label>'+'<input type="text" placeholder="Enter correct provider(s)" id="internet-card-correction"/>'+'<button class="up-feedback-submit" data-card="internet-card" data-type="internet">Submit</button>'+'</div>'+'</div>';}singleForm.addEventListener('submit',function (e){e.preventDefault();var address=addressInput.value.trim();if(!address)return;var utilities=getSelectedUtilities(document.getElementById('singleToggles'));if(utilities.length===0){utilityResults.innerHTML='<div class="up-error">Please select at least one utility type.</div>';return;}searchBtn.disabled=true;searchBtn.textContent='Searching...';var loadingHtml='<div class="up-status-message"><div class="up-loading-spinner"></div><span>Looking up utilities...</span></div>';utilities.forEach(function (u){loadingHtml+='<div id="slot-'+u+'" class="up-card" style="opacity:0.5;"><div class="up-card-header"><div class="up-card-type"><div class="up-icon up-icon-'+u+'">'+icons[u]+'</div><span class="up-type-label">'+typeLabels[u]+'</span></div></div><div style="display:flex;align-items:center;gap:8px;"><div class="up-loading-spinner-small"></div>Looking up...</div></div>';});utilityResults.innerHTML=loadingHtml;var params=new URLSearchParams({address:address,utilities:utilities.join(',')});var eventSource=new EventSource(STREAM_URL+'?'+params);var streamData={location:null};eventSource.onmessage=function (event){try{var msg=JSON.parse(event.data);if(msg.event==='geocode'&&msg.data){streamData.location=msg.data;var locHtml='<div class="up-location"><span class="up-location-icon">üìç</span>'+(msg.data.matched_address||address)+'</div>';var statusEl=utilityResults.querySelector('.up-status-message');if(statusEl)statusEl.outerHTML=locHtml;}if(msg.event==='electric'){var slot=document.getElementById('slot-electric');if(slot){if(msg.data)slot.outerHTML=renderUtilityCard(msg.data[0]||msg.data,'electric',address);else slot.outerHTML='<div class="up-card"><div class="up-no-result">‚ö° No electric provider found</div></div>';}}if(msg.event==='gas'){var slot=document.getElementById('slot-gas');if(slot){if(msg.data)slot.outerHTML=renderUtilityCard(msg.data[0]||msg.data,'gas',address);else slot.outerHTML='<div class="up-card"><div class="up-no-result">üî• No gas provider found</div></div>';}}if(msg.event==='water'){var slot=document.getElementById('slot-water');if(slot){if(msg.data)slot.outerHTML=renderUtilityCard(msg.data[0]||msg.data,'water',address);else slot.outerHTML='<div class="up-card"><div class="up-no-result">üíß No water provider found</div></div>';}}if(msg.event==='sewer'){var slot=document.getElementById('slot-sewer');if(slot){if(msg.data)slot.outerHTML=renderUtilityCard(msg.data[0]||msg.data,'sewer',address);else slot.outerHTML='<div class="up-card"><div class="up-no-result">üöø No sewer provider found</div></div>';}}if(msg.event==='internet'){var slot=document.getElementById('slot-internet');if(slot){if(msg.data)slot.outerHTML=renderInternetCard(msg.data);else slot.outerHTML='<div class="up-card"><div class="up-no-result">üåê No internet providers found</div></div>';}}if(msg.event==='complete'){eventSource.close();searchBtn.disabled=false;searchBtn.textContent='Search';attachFeedbackListeners();if(typeof logSearch==='function'){var lr={};var keyMap={'Electric':'electric','ELECTRIC':'electric','Natural Gas':'gas','NATURAL GAS':'gas','Water':'water','WATER':'water','Internet':'internet','INTERNET':'internet'};document.querySelectorAll('.up-card').forEach(function(c){var t=c.querySelector('.up-type-label'),n=c.querySelector('.up-provider-name');if(t){var key=keyMap[t.textContent.trim()]||t.textContent.toLowerCase();if(n){lr[key]=n.textContent;}else if(key==='internet'){var providers=[];c.querySelectorAll('.up-internet-provider-cell').forEach(function(p){providers.push(p.textContent.trim());});if(providers.length>0)lr[key]=providers.join(', ');}}});logSearch(address,utilities,lr);}}if(msg.event==='error'){eventSource.close();utilityResults.innerHTML='<div class="up-error">'+(msg.message||'An error occurred')+'</div>';searchBtn.disabled=false;searchBtn.textContent='Search';}}catch(err){console.error('Parse error:',err);}};eventSource.onerror=function (){eventSource.close();searchBtn.disabled=false;searchBtn.textContent='Search';};});multiSearchBtn.addEventListener('click',async function (){var text=multiInput.value.trim();if(!text)return;var addresses=text.split('\n') .map(function (a){return a.trim();}) .filter(function (a){return a;});if(addresses.length===0)return;if(addresses.length>20){alert('Maximum 20 addresses. Please reduce your list.');return;}var utilities=getSelectedUtilities(document.getElementById('multiToggles'));if(utilities.length===0){alert('Please select at least one utility type.');return;}multiSearchBtn.disabled=true;multiSearchBtn.textContent='Looking up...';multiResults.classList.remove('up-hidden');multiResults.innerHTML=addresses.map(function (addr,i){return '<div class="up-multi-section" id="multi-section-'+i+'">'+'<div class="up-multi-address">'+'<span class="up-multi-address-icon">üìç</span>'+'<span class="up-multi-address-text">'+addr+'</span>'+'<span class="up-multi-address-status loading" id="multi-status-'+i+'"><span class="up-loading-spinner-small"></span>Looking up...</span>'+'</div>'+'<div class="up-multi-utilities" id="multi-utils-'+i+'"></div>'+'</div>';}) .join('');for(var i=0;i<addresses.length;i++){var address=addresses[i];var utilsContainer=document.getElementById('multi-utils-'+i);var statusEl=document.getElementById('multi-status-'+i);try{var params=new URLSearchParams({address:address,utilities:utilities.join(',')});var response=await fetch(API_URL+'?'+params);var data=await response.json();if(data.error){statusEl.className='up-multi-address-status error';statusEl.textContent='Error';utilsContainer.innerHTML='<div class="up-error">'+data.error+'</div>';}else{statusEl.className='up-multi-address-status complete';statusEl.textContent='Complete';var cardsHtml='';if(utilities.indexOf('electric')>=0){if(data.utilities.electric&&data.utilities.electric.length>0){cardsHtml+=renderUtilityCard(data.utilities.electric[0],'electric',address);}else{cardsHtml+='<div class="up-card"><div class="up-no-result">‚ö° No electric provider found</div></div>';}}if(utilities.indexOf('gas')>=0){if(data.utilities.gas&&data.utilities.gas.length>0){cardsHtml+=renderUtilityCard(data.utilities.gas[0],'gas',address);}else{cardsHtml+='<div class="up-card"><div class="up-no-result">üî• No gas provider found</div></div>';}}if(utilities.indexOf('water')>=0){if(data.utilities.water&&data.utilities.water.length>0){cardsHtml+=renderUtilityCard(data.utilities.water[0],'water',address);}else{cardsHtml+='<div class="up-card"><div class="up-no-result">üíß No water provider found</div></div>';}}if(utilities.indexOf('sewer')>=0){if(data.utilities.sewer&&data.utilities.sewer.length>0){cardsHtml+=renderUtilityCard(data.utilities.sewer[0],'sewer',address);}else{cardsHtml+='<div class="up-card"><div class="up-no-result">üöø No sewer provider found</div></div>';}}if(utilities.indexOf('internet')>=0){if(data.utilities.internet&&data.utilities.internet.providers&&data.utilities.internet.providers.length>0){cardsHtml+=renderInternetCard(data.utilities.internet);}else{cardsHtml+='<div class="up-card"><div class="up-no-result">üåê No internet providers found</div></div>';}}utilsContainer.innerHTML=cardsHtml;attachFeedbackListeners();}}catch(err){statusEl.className='up-multi-address-status error';statusEl.textContent='Error';utilsContainer.innerHTML='<div class="up-error">Failed to look up this address</div>';}await new Promise(function (r){setTimeout(r,300);});}multiSearchBtn.disabled=false;multiSearchBtn.textContent='Look Up All';});function attachFeedbackListeners(){document.querySelectorAll('.up-badge-confidence:not([data-listener])') .forEach(function (badge){badge.setAttribute('data-listener','true');badge.addEventListener('click',function (e){e.stopPropagation();var dropdownId=this.dataset.dropdown;var dropdown=document.getElementById(dropdownId);document.querySelectorAll('.up-confidence-dropdown.open') .forEach(function (d){if(d.id!==dropdownId)d.classList.remove('open');});document.querySelectorAll('.up-badge-confidence.open') .forEach(function (b){if(b!==this)b.classList.remove('open');});if(dropdown)dropdown.classList.toggle('open');this.classList.toggle('open');});});document.querySelectorAll('.up-feedback-btn-small:not(.up-alt-btn):not([data-listener])') .forEach(function (btn){btn.setAttribute('data-listener','true');btn.addEventListener('click',function (){var feedback=this.closest('.up-feedback-inline');var cardId=feedback.dataset.card;var type=feedback.dataset.type;var provider=feedback.dataset.provider;var address=feedback.dataset.address;var response=this.dataset.response;feedback.querySelectorAll('.up-feedback-btn-small') .forEach(function (b){b.classList.remove('selected');});this.classList.add('selected');if(response==='yes'){if(typeof logFeedback==='function')logFeedback(type,provider,address,true,'');feedback.querySelectorAll('.up-feedback-btn-small').forEach(function(b){b.style.display='none';});var urlForm=document.getElementById(cardId+'-url-form');if(urlForm)urlForm.classList.add('open');}else{var corrForm=document.getElementById(cardId+'-form');if(corrForm)corrForm.classList.add('open');}});});document.querySelectorAll('.up-feedback-submit:not([data-listener])') .forEach(function (btn){btn.setAttribute('data-listener','true');btn.addEventListener('click',function (){var cardId=this.dataset.card;var type=this.dataset.type;var correction=document.getElementById(cardId+'-correction') .value.trim();if(!correction){alert('Please enter the correct provider name');return;}var feedback=document.querySelector('.up-feedback-inline[data-card="'+cardId+'"]');var provider=feedback?feedback.dataset.provider:'';var address=feedback?feedback.dataset.address:'';if(typeof logFeedback==='function')logFeedback(type,provider,address,false,correction);fetch(FEEDBACK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:address,utility_type:type,returned_provider:provider,correct_provider:correction,is_correct:false,source:'web_widget'})}) .catch(function (e){console.error('Feedback error:',e);});document.getElementById(cardId+'-form') .classList.remove('open');if(feedback)feedback.querySelectorAll('.up-feedback-btn-small') .forEach(function (b){b.style.display='none';});var doneEl=document.getElementById(cardId+'-done');if(doneEl)doneEl.classList.add('show');});});document.querySelectorAll('.up-url-submit:not([data-listener])') .forEach(function (btn){btn.setAttribute('data-listener','true');btn.addEventListener('click',function (){var cardId=this.dataset.card;var type=this.dataset.type;var serviceUrl=document.getElementById(cardId+'-service-url') .value.trim();var feedback=document.querySelector('.up-feedback-inline[data-card="'+cardId+'"]');var provider=feedback?feedback.dataset.provider:'';var address=feedback?feedback.dataset.address:'';fetch(FEEDBACK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:address,utility_type:type,returned_provider:provider,is_correct:true,service_check_url:serviceUrl||null,source:'web_widget'})}) .catch(function (e){console.error('Feedback error:',e);});if(typeof logFeedback==='function')logFeedback(type,provider,address,true,'',serviceUrl);document.getElementById(cardId+'-url-form').classList.remove('open');var doneEl=document.getElementById(cardId+'-done');if(doneEl)doneEl.classList.add('show');});});document.querySelectorAll('.up-url-skip:not([data-listener])') .forEach(function (btn){btn.setAttribute('data-listener','true');btn.addEventListener('click',function (){var cardId=this.dataset.card;var feedback=document.querySelector('.up-feedback-inline[data-card="'+cardId+'"]');var type=feedback?feedback.dataset.type:'';var provider=feedback?feedback.dataset.provider:'';var address=feedback?feedback.dataset.address:'';fetch(FEEDBACK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:address,utility_type:type,returned_provider:provider,is_correct:true,source:'web_widget'})}) .catch(function (e){console.error('Feedback error:',e);});if(typeof logFeedback==='function')logFeedback(type,provider,address,true,'');document.getElementById(cardId+'-url-form').classList.remove('open');var doneEl=document.getElementById(cardId+'-done');if(doneEl)doneEl.classList.add('show');});});document.querySelectorAll('.up-alt-btn:not([data-listener])') .forEach(function (btn){btn.setAttribute('data-listener','true');btn.addEventListener('click',function (){var altId=this.dataset.altId;var provider=this.dataset.provider;var type=this.dataset.type;var response=this.dataset.response;var feedback=this.closest('.up-feedback-inline');feedback.querySelectorAll('.up-feedback-btn-small') .forEach(function (b){b.classList.remove('selected');b.style.display='none';});this.classList.add('selected');var doneEl=document.getElementById(altId+'-done');if(doneEl)doneEl.classList.add('show');fetch(FEEDBACK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({utility_type:type,returned_provider:provider,is_correct:response==='yes',is_alternative:true,source:'web_widget_alt'})}) .catch(function (e){console.error('Feedback error:',e);});});});document.querySelectorAll('.up-other-toggle:not([data-listener])') .forEach(function (toggle){toggle.setAttribute('data-listener','true');toggle.addEventListener('click',function (){var targetId=this.dataset.target;var list=document.getElementById(targetId);if(list){list.classList.toggle('open');this.classList.toggle('open');var caret=this.querySelector('.up-other-caret');if(caret)caret.textContent=list.classList.contains('open')?'‚ñ≤':'‚ñº';}});});document.addEventListener('click',function (e){if(!e.target.closest('.up-badge-confidence')&&!e.target.closest('.up-confidence-dropdown')){document.querySelectorAll('.up-confidence-dropdown.open') .forEach(function (d){d.classList.remove('open');});document.querySelectorAll('.up-badge-confidence.open') .forEach(function (b){b.classList.remove('open');});}});}var csvDropZone=document.getElementById('csvDropZone');var csvInput=document.getElementById('csvInput');var csvSelectBtn=document.getElementById('csvSelectBtn');var csvProgress=document.getElementById('csvProgress');var csvProgressFill=document.getElementById('csvProgressFill');var csvProgressText=document.getElementById('csvProgressText');var csvResults=document.getElementById('csvResults');var csvSuccessCount=document.getElementById('csvSuccessCount');var csvErrorCount=document.getElementById('csvErrorCount');var csvDownloadBtn=document.getElementById('csvDownloadBtn');var csvData=[];if(csvDropZone){csvDropZone.addEventListener('dragover',function (e){e.preventDefault();csvDropZone.style.borderColor='#7AC143';});csvDropZone.addEventListener('dragleave',function (){csvDropZone.style.borderColor='#e5e7eb';});csvDropZone.addEventListener('drop',function (e){e.preventDefault();csvDropZone.style.borderColor='#e5e7eb';var file=e.dataTransfer.files[0];if(file&&file.name.endsWith('.csv'))processCSV(file);else alert('Please upload a CSV file');});}if(csvSelectBtn)csvSelectBtn.addEventListener('click',function (e){e.stopPropagation();csvInput.click();});if(csvInput)csvInput.addEventListener('change',function (e){var file=e.target.files[0];if(file)processCSV(file);});async function processCSV(file){var text=await file.text();var lines=text.split('\n') .map(function (l){return l.trim();}) .filter(function (l){return l;});if(lines.length<2){alert('CSV must have a header row and at least one address');return;}var headers=lines[0].split(',') .map(function (h){return h.trim() .toLowerCase() .replace(/"/g,'');});var addressIdx=headers.indexOf('address');if(addressIdx<0){alert('CSV must have an "address" column');return;}var addresses=[];for(var i=1;i<lines.length&&i<=100;i++){var cols=lines[i].split(',') .map(function (c){return c.trim() .replace(/"/g,'');});if(cols[addressIdx])addresses.push({original:lines[i],address:cols[addressIdx]});}if(addresses.length===0){alert('No valid addresses found');return;}csvDropZone.style.display='none';csvProgress.classList.add('show');csvData=[];var successCount=0,errorCount=0;for(var i=0;i<addresses.length;i++){csvProgressFill.style.width=((i+1)/addresses.length*100)+'%';csvProgressText.textContent='Processing '+(i+1)+' of '+addresses.length+'...';try{var params=new URLSearchParams({address:addresses[i].address,utilities:'electric,gas,water,internet'});var response=await fetch(API_URL+'?'+params);var data=await response.json();csvData.push({address:addresses[i].address,electric:data.utilities.electric?data.utilities.electric[0].name:'',gas:data.utilities.gas?data.utilities.gas[0].name:'',water:data.utilities.water?data.utilities.water[0].name:'',internet:data.utilities.internet&&data.utilities.internet.providers?data.utilities.internet.providers.map(function (p){return p.name;}) .join(';'):'',status:'success'});successCount++;}catch(err){csvData.push({address:addresses[i].address,electric:'',gas:'',water:'',internet:'',status:'error'});errorCount++;}await new Promise(function (r){setTimeout(r,300);});}csvProgress.classList.remove('show');csvResults.classList.add('show');csvSuccessCount.textContent=successCount;csvErrorCount.textContent=errorCount;}if(csvDownloadBtn){csvDownloadBtn.addEventListener('click',function (){var csvContent='Address,Electric,Gas,Water,Internet,Status\n';csvData.forEach(function (row){csvContent+='"'+row.address+'","'+row.electric+'","'+row.gas+'","'+row.water+'","'+row.internet+'","'+row.status+'"\n';});var blob=new Blob([csvContent],{type:'text/csv'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='utility_results.csv';a.click();});}})();</script>
