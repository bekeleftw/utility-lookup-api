<!-- Utility Lookup with Auth Wrapper - Paste this into Webflow -->
<style>
.upa-login{max-width:360px;margin:60px auto;background:#fff;border-radius:12px;padding:32px;box-shadow:0 4px 12px rgba(0,0,0,.08);text-align:center;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.upa-login h2{font-size:20px;font-weight:600;color:#1a1a1a;margin:0 0 4px}
.upa-login p{color:#6b7280;font-size:14px;margin:0 0 24px}
.upa-error{background:#fef2f2;color:#dc2626;padding:10px;border-radius:6px;font-size:13px;margin-bottom:16px;display:none}
.upa-field{margin-bottom:16px;text-align:left}
.upa-field label{display:block;font-size:13px;font-weight:500;color:#374151;margin-bottom:6px}
.upa-field input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;box-sizing:border-box}
.upa-field input:focus{outline:none;border-color:#7AC143;box-shadow:0 0 0 3px rgba(122,193,67,.1)}
.upa-btn{width:100%;padding:12px;background:#7AC143;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer}
.upa-btn:hover{background:#5a9a30}
.upa-btn:disabled{background:#9ca3af;cursor:not-allowed}
.upa-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:#f0f9e8;border-radius:8px;margin-bottom:16px;font-size:13px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.upa-bar span{color:#374151}
.upa-logout{padding:4px 10px;font-size:12px;background:#fff;border:1px solid #e5e7eb;color:#6b7280;border-radius:4px;cursor:pointer}
.upa-logout:hover{background:#f3f4f6}
.upa-stats{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,.08);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.upa-stats h3{font-size:16px;font-weight:600;color:#374151;margin:0 0 16px;display:flex;justify-content:space-between;align-items:center}
.upa-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.upa-stat{background:#f9fafb;border-radius:8px;padding:12px;text-align:center}
.upa-stat-val{font-size:24px;font-weight:700;color:#111827}
.upa-stat-lbl{font-size:12px;color:#6b7280;margin-top:4px}
.upa-tbl{width:100%;border-collapse:collapse;font-size:13px}
.upa-tbl th{text-align:left;padding:8px;border-bottom:2px solid #e5e7eb;color:#6b7280;font-weight:500;font-size:11px;text-transform:uppercase}
.upa-tbl td{padding:8px;border-bottom:1px solid #f3f4f6}
.upa-tbl tr:hover{background:#f9fafb}
.upa-name{font-weight:500;color:#111827}
.upa-email{font-size:11px;color:#9ca3af}
.upa-grn{color:#10b981}
.upa-red{color:#ef4444}
.upa-refresh{padding:4px 10px;font-size:12px;background:#fff;border:1px solid #e5e7eb;color:#374151;border-radius:4px;cursor:pointer}
@media(max-width:600px){.upa-stats-grid{grid-template-columns:repeat(2,1fr)}}
</style>

<div id="upaLogin" class="upa-login">
  <h2>Utility Lookup</h2>
  <p>Sign in to continue</p>
  <div id="upaError" class="upa-error"></div>
  <div class="upa-field"><label>Email</label><input type="email" id="upaEmail" placeholder="you@company.com"></div>
  <div class="upa-field"><label>Password</label><input type="password" id="upaPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
  <button id="upaBtn" class="upa-btn">Sign In</button>
</div>

<div id="upaApp" style="display:none;">
  <div class="upa-bar">
    <span>ðŸ‘‹ Welcome, <strong id="upaUser"></strong></span>
    <button id="upaLogout" class="upa-logout">Sign Out</button>
  </div>
  
  <div id="upaStats" class="upa-stats" style="display:none;">
    <h3>ðŸ“Š Usage Statistics <button id="upaRefresh" class="upa-refresh">Refresh</button></h3>
    <div class="upa-stats-grid">
      <div class="upa-stat"><div class="upa-stat-val" id="upaTotalSearches">-</div><div class="upa-stat-lbl">Total Searches</div></div>
      <div class="upa-stat"><div class="upa-stat-val" id="upaTotalUsers">-</div><div class="upa-stat-lbl">Active Users</div></div>
      <div class="upa-stat"><div class="upa-stat-val" id="upaAccuracy">-</div><div class="upa-stat-lbl">Accuracy Rate</div></div>
      <div class="upa-stat"><div class="upa-stat-val" id="upaFeedback">-</div><div class="upa-stat-lbl">Feedback Rate</div></div>
    </div>
    <table class="upa-tbl">
      <thead><tr><th>User</th><th>Searches</th><th class="upa-grn">âœ“</th><th class="upa-red">âœ—</th><th>Accuracy</th><th>Last Active</th></tr></thead>
      <tbody id="upaTblBody"></tbody>
    </table>
  </div>
  
  <div id="upaToolContainer">
    <!-- The existing utility lookup tool will be injected here -->
  </div>
</div>

<script>
(function(){
  var AUTH_URL='https://web-production-9acc6.up.railway.app/api/utility-auth';
  var USAGE_URL='https://web-production-9acc6.up.railway.app/api/utility-usage';
  var currentUser=null,authToken=null,lastLogId=null;
  
  // Auth functions
  async function checkAuth(){
    var token=localStorage.getItem('utility_auth_token');
    if(!token){showLogin();return;}
    try{
      var res=await fetch(AUTH_URL+'/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:token})});
      var data=await res.json();
      if(data.valid){authToken=token;currentUser=data.user;showApp();}
      else{localStorage.removeItem('utility_auth_token');showLogin();}
    }catch(e){showLogin();}
  }
  
  async function handleLogin(){
    var email=document.getElementById('upaEmail').value.trim();
    var pass=document.getElementById('upaPass').value;
    var err=document.getElementById('upaError');
    var btn=document.getElementById('upaBtn');
    if(!email||!pass){err.textContent='Please enter email and password';err.style.display='block';return;}
    btn.disabled=true;btn.textContent='Signing in...';err.style.display='none';
    try{
      var res=await fetch(AUTH_URL+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email,password:pass})});
      var data=await res.json();
      if(data.success){localStorage.setItem('utility_auth_token',data.token);authToken=data.token;currentUser=data.user;showApp();}
      else{err.textContent=data.error||'Login failed';err.style.display='block';}
    }catch(e){err.textContent='Connection error';err.style.display='block';}
    btn.disabled=false;btn.textContent='Sign In';
  }
  
  function showLogin(){document.getElementById('upaLogin').style.display='block';document.getElementById('upaApp').style.display='none';}
  function showApp(){
    document.getElementById('upaLogin').style.display='none';
    document.getElementById('upaApp').style.display='block';
    document.getElementById('upaUser').textContent=currentUser.name||currentUser.email;
    if(currentUser.is_admin){document.getElementById('upaStats').style.display='block';loadStats();}
    loadTool();
  }
  function handleLogout(){localStorage.removeItem('utility_auth_token');authToken=null;currentUser=null;showLogin();}
  
  // Stats
  async function loadStats(){
    if(!authToken||!currentUser||!currentUser.is_admin)return;
    try{
      var res=await fetch(USAGE_URL+'/stats',{headers:{'Authorization':'Bearer '+authToken}});
      var data=await res.json();
      if(data.success)renderStats(data);
    }catch(e){}
  }
  
  function renderStats(data){
    document.getElementById('upaTotalSearches').textContent=data.totals.total_searches.toLocaleString();
    document.getElementById('upaTotalUsers').textContent=data.totals.total_users;
    document.getElementById('upaAccuracy').textContent=(data.totals.overall_accuracy*100).toFixed(1)+'%';
    document.getElementById('upaFeedback').textContent=(data.totals.overall_feedback_rate*100).toFixed(1)+'%';
    var tbody=document.getElementById('upaTblBody');
    tbody.innerHTML=data.users.map(function(u){
      var ago=u.last_active?formatTime(u.last_active):'Never';
      return '<tr><td><div class="upa-name">'+esc(u.name)+'</div><div class="upa-email">'+esc(u.email)+'</div></td><td>'+u.total_searches+'</td><td class="upa-grn">'+u.marked_correct+'</td><td class="upa-red">'+u.marked_incorrect+'</td><td>'+(u.accuracy_rate*100).toFixed(0)+'%</td><td>'+ago+'</td></tr>';
    }).join('');
  }
  
  function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
  function formatTime(iso){
    var d=new Date(iso),now=new Date(),diff=now-d,m=Math.floor(diff/60000),h=Math.floor(diff/3600000),dy=Math.floor(diff/86400000);
    if(m<60)return m+'m ago';if(h<24)return h+'h ago';if(dy<7)return dy+'d ago';return d.toLocaleDateString();
  }
  
  // Usage logging - exposed globally for the tool to call
  window.logUtilitySearch=async function(address,utilities,results){
    if(!authToken)return;
    try{
      var res=await fetch(USAGE_URL+'/log',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:authToken,address:address,utilities_requested:utilities,results:results})});
      var data=await res.json();
      if(data.success)lastLogId=data.log_id;
    }catch(e){}
  };
  
  window.submitUtilityFeedback=async function(feedback,details){
    if(!authToken||!lastLogId)return;
    try{await fetch(USAGE_URL+'/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:authToken,log_id:lastLogId,feedback:feedback,details:details||null})});}catch(e){}
  };
  
  // Load the main tool
  function loadTool(){
    // Fetch and inject the main utility lookup tool
    var container=document.getElementById('upaToolContainer');
    // For now, we'll use an iframe or you can paste the tool HTML directly here
    container.innerHTML='<p style="text-align:center;color:#6b7280;padding:40px;">Loading utility lookup tool...</p>';
    
    // Option 1: Load via fetch (if hosted)
    // fetch('/static/widget.html').then(r=>r.text()).then(html=>{container.innerHTML=html;});
    
    // Option 2: The tool HTML is included below (paste webflow_embed_unified.html content here)
    // For production, replace this placeholder with the actual tool
  }
  
  // Event listeners
  document.getElementById('upaBtn').addEventListener('click',handleLogin);
  document.getElementById('upaPass').addEventListener('keypress',function(e){if(e.key==='Enter')handleLogin();});
  document.getElementById('upaLogout').addEventListener('click',handleLogout);
  document.getElementById('upaRefresh').addEventListener('click',loadStats);
  
  // Init
  checkAuth();
})();
</script>
